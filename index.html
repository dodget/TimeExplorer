<!DOCTYPE HTML>
<html>
<head>
  <title>Timeline | Aggregated Timeline</title>

  <style id="docstyle" type="text/css">
  .vis-item.vis-background {
    opacity: 0.6;
  }
  </style>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.4/handlebars.min.js"></script>

  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.20.0/vis.min.js"></script>
  <script type="text/javascript" src="js/palette.js"></script>
  <script type="text/javascript" src="js/fabulousTime.js"></script>
  <!-- Timeline JS timeline script -->
  <script type="text/javascript" src="js/timeline.js" charset="utf-8"></script>

  <!-- JQuery UI -->
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

  <script type="text/javascript">
  </script>

  <script id="item-template" type="text/x-handlebars-template">
    <!-- <p>{{headline}}</p> -->
  </script>

  <script id="item-data-template" type="text/x-handlebars-template">
    <div class="close-button vcenter-outer">
      <div class="vcenter-middle">
        <span class="vcenter-inner">X</span>
      </div>
    </div>
    <div id="item-text">
      <div class="vcenter-outer cols-1">
        <div class="vcenter-middle">
          <div class="vcenter-inner">
            <h1>{{headline}}</h1>
            <p class="display-date">{{display_date}}</p>
            <p>{{{text}}}</p>
          </div>
        </div>
      </div>
    </div>
  </script>

  <link rel="stylesheet" type="text/css" href="css/timeline.css">
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.20.0/vis.min.css"/>
  <link rel="stylesheet" type="text/css" href="css/fabuloustime.css"/>
  <style media="screen" id="dynamicstyle"></style>
</head>
<body>
  <div id="container">
    <div id="filters"></div>

    <div id="item-data">
      <span class="close">X</span>
    </div>

    <div id="visualization"></div>
  </div>

  <div id="timeline-setup" title="How do you have your Timeline(s) set up?" class="ui-form">
    <p>This application transforms Timeline JS timelines into a format that makes browsing the timeline easier, at the cost of some of the excellent aesthetics of Timeline JS.</p>
    <p>You can enter the URL for a Google Sheet that defines a single timeline, or a Google Sheet that contains a list of other Google Sheets in the first column, which will aggregate the contents of all of those sheets.</p>
    <p>For any setup, the spreadsheets must be set to "Anyone with the link can view" for this system to be able to access them.</p>
    <p>How would you like to set up your timeline?</p>
  </div>

  <div id="timeline-single-entry" title="Single Sheet Timeline" class="ui-form">
    <form>
      <div>
        <label for="single-sheet-url">Sheet URL: </label>
        <input type="text" name="single-sheet-url" id="single-sheet-url">
      </div>
      <div>
        <label for="page-height">Page Height: </label>
        <input type="number" name="page-height" value="1000" id="page-height">
      </div>
      <div>
        <label for="tag-column">Tag Column Name (Optional): </label>
        <input type="text" name="tag-column" id="tag-column">
      </div>
    </form>
  </div>

  <div id="timeline-multi-entry" title="Aggregated Timeline" class="ui-form">
    <form>
      <div>
        <label for="multi-sheet-url">Sheet URL: </label>
        <input type="text" name="multi-sheet-url" id="multi-sheet-url">
      </div>
      <div>
        <label for="page-height">Page Height: </label>
        <input type="number" name="page-height" value="1000" id="page-height">
      </div>
      <div>
        <label for="tag-column">Tag Column Name (Optional): </label>
        <input type="text" name="tag-column" id="tag-column">
      </div>
    </form>
  </div>

  <script type="text/javascript">
    var $_GET = {};

    document.location.search.replace(/\??(?:([^=]+)=([^&]*)&?)/g, function () {
        function decode(s) {
            return decodeURIComponent(s.split("+").join(" "));
        }

        $_GET[decode(arguments[1])] = decode(arguments[2]);
    });
    var container = document.getElementById('visualization');
    var timeline = new vis.Timeline(container);

    var api_key = "AIzaSyDkbD0QpwfTfpMSWBE4get0Mqt17uV4mv0"
    FabTimeline = new FabulousTime(api_key,timeline);

    $(document).ready(function() {

      var container_height = get_url_params()['height'];
      if (container_height == null) {
        container_height = 1000;
      }
      $('#container').height(container_height);
      $('#filters').height(container_height);
      $('#item-data').height(0);
      $('#visualization').height(container_height);
      $('#dynamicstyle').append(
        `.tl-media-content {max-height:${container_height}px;}`,
        `#item-data {height:${0.7*container_height}px; top:${0.15*container_height}px;}`
      )

      // create a handlebars template
      var source = document.getElementById('item-template').innerHTML;
      var template = Handlebars.compile(source);
      var options = {
        template: template,
        height: 1000,
        dataAttributes: ['text','media'],
        // horizontalScroll: true,
        // zoomKey: 'ctrlKey',
        margin: {
          item: 5,
          axis: 10,
        },
        tooltip: {
          followMouse: true,
        },
        format: {
          minorLabels: {
            millisecond:'SSS',
            second:     's',
            minute:     'h:mm a',
            hour:       'h:mm a',
            weekday:    'ddd D',
            day:        'D',
            month:      'MMM',
            year:       'YYYY'
          },
          majorLabels: {
            millisecond:'h:mm:ss a',
            second:     'D MMMM h:mm ',
            minute:     'ddd D MMMM',
            hour:       'ddd D MMMM',
            weekday:    'MMMM YYYY',
            day:        'MMMM YYYY',
            month:      'YYYY',
            year:       ''
          }
        }
      };
      $("#item-data").css('height',$(window).height()-options['maxHeight']);

      var item_data_source = $('#item-data-template').html();
      var item_data_template = Handlebars.compile(item_data_source);

      FabTimeline.ready.done(function() {
        $('#item-data').empty();
        if (FabTimeline.title_entry) {
          RenderItem(FabTimeline.title_entry,item_data_template);
        }
        var contents = item_data_template(FabTimeline.title_entry)
        container = document.getElementById('visualization');
        var the_items = new vis.DataSet(FabTimeline.items);
        timeline.setItems(the_items);
        timeline.setOptions(options);
        timeline.on('select',function(properties) {
          selected_item = the_items._getItem(properties.items[0]);
          if (selected_item) {
            RenderItem(selected_item,item_data_template);
          } else if (FabTimeline.title_entry) {
            RenderItem(FabTimeline.title_entry,item_data_template);
          } else {
            HideItemDetails();
          }
        });
      });
    });
  </script>
</body>
</html>
