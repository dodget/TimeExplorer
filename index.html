<!DOCTYPE HTML>
<html>
<head>
  <title>Timeline | Aggregated Timeline</title>

  <style id="docstyle" type="text/css">
  .vis-item.vis-background {
    opacity: 0.6;
  }
  </style>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.4/handlebars.min.js"></script>

  <script type="text/javascript" src="js/vis.js"></script>
  <script type="text/javascript" src="js/palette.js"></script>
  <script type="text/javascript" src="js/fabulousTime.js"></script>
  <script type="text/javascript" src="js/timeline.js"></script>

  <!-- JQuery UI -->
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

  <script type="text/javascript">
  </script>

  <script id="item-template" type="text/x-handlebars-template">
    {{headline}}
  </script>

  <script id="item-data-template" type="text/x-handlebars-template">
    <div id="item-text">
      <h1>{{headline}}</h1>
      <p>{{{text}}}</p>
    </div>

  </script>

  <link rel="stylesheet" type="text/css" href="css/timeline.css">
  <link rel="stylesheet" type="text/css" href="css/vis.css"/>
  <link rel="stylesheet" type="text/css" href="css/sheet_vis.css"/>
  <style media="screen" id="dynamicstyle"></style>
</head>
<body>
  <div id="container">
    <div id="filters"></div>

    <div id="item-data"></div>

    <div id="visualization"></div>
  </div>

  <div id="timeline-setup" title="How do you have your Timeline(s) set up?" class="ui-form">
    <p>This application transforms Timeline JS timelines into a format that makes browsing the timeline easier, at the cost of some of the excellent aesthetics of Timeline JS.</p>
    <p>You can enter the URL for a Google Sheet that defines a single timeline, or a Google Sheet that contains a list of other Google Sheets in the first column, which will aggregate the contents of all of those sheets.</p>
    <p>For any setup, the spreadsheets must be set to "Anyone with the link can view" for this system to be able to access them.</p>
    <p>How would you like to set up your timeline?</p>
  </div>

  <div id="timeline-single-entry" title="Single Sheet Timeline" class="ui-form">
    <form>
      <div>
        <label for="single-sheet-url">Sheet URL: </label>
        <input type="text" name="single-sheet-url" id="single-sheet-url">
      </div>
      <div>
        <label for="page-height">Page Height: </label>
        <input type="number" name="page-height" value="1000" id="page-height">
      </div>
      <div>
        <label for="tag-column">Tag Column Name (Optional): </label>
        <input type="text" name="tag-column" id="tag-column">
      </div>
    </form>
  </div>

  <div id="timeline-multi-entry" title="Aggregated Timeline" class="ui-form">
    <form>
      <div>
        <label for="multi-sheet-url">Sheet URL: </label>
        <input type="text" name="multi-sheet-url" id="multi-sheet-url">
      </div>
      <div>
        <label for="page-height">Page Height: </label>
        <input type="number" name="page-height" value="1000" id="page-height">
      </div>
      <div>
        <label for="tag-column">Tag Column Name (Optional): </label>
        <input type="text" name="tag-column" id="tag-column">
      </div>
    </form>
  </div>

  <script type="text/javascript">
    var $_GET = {};

    document.location.search.replace(/\??(?:([^=]+)=([^&]*)&?)/g, function () {
        function decode(s) {
            return decodeURIComponent(s.split("+").join(" "));
        }

        $_GET[decode(arguments[1])] = decode(arguments[2]);
    });
    var container = document.getElementById('visualization');
    var timeline = new vis.Timeline(container);

    var api_key = "AIzaSyDkbD0QpwfTfpMSWBE4get0Mqt17uV4mv0"
    test = new FabulousTime(api_key,timeline);

    $(document).ready(function() {

      var container_height = get_url_params()['height'];
      if (container_height == null) {
        container_height = 1000;
      }
      $('#container').height(container_height);
      $('#filters').height(container_height);
      $('#item-data').height(0.6*container_height);
      $('#visualization').height(0.4*container_height);
      $('#dynamicstyle').append(`.tl-media-content {max-height:${0.4*container_height}px;}`)

      // create a handlebars template
      var source = document.getElementById('item-template').innerHTML;
      var template = Handlebars.compile(source);
      var options = {
        template: template,
        height: 0.4*container_height,
        dataAttributes: ['text','media'],
        horizontalScroll: true,
        zoomKey: 'ctrlKey',
        format: {
          minorLabels: {
            millisecond:'SSS',
            second:     's',
            minute:     'h:mm a',
            hour:       'h:mm a',
            weekday:    'ddd D',
            day:        'D',
            month:      'MMM',
            year:       'YYYY'
          },
          majorLabels: {
            millisecond:'h:mm:ss a',
            second:     'D MMMM h:mm ',
            minute:     'ddd D MMMM',
            hour:       'ddd D MMMM',
            weekday:    'MMMM YYYY',
            day:        'MMMM YYYY',
            month:      'YYYY',
            year:       ''
          }
        }
      };
      $("#item-data").css('height',$(window).height()-options['maxHeight']);

      var item_data_source = $('#item-data-template').html();
      var item_data_template = Handlebars.compile(item_data_source);

      test.ready.done(function() {
        container = document.getElementById('visualization');
        var the_items = new vis.DataSet(test.items);
        timeline.setItems(the_items);
        timeline.setOptions(options);
        timeline.on('select',function(properties) {
          $('#item-data').empty();
          if (properties.items.length > 0){
            var contents = item_data_template(the_items._getItem(properties.items[0]));
            $('#item-data').append(contents);
            var item_media_dict = the_items._getItem(properties.items[0])['media'];
            if (item_media_dict['url'] && item_media_dict['url']!="") {
              $('#item-data').append('<div id="item-media" class="cols-2"></div>');
              $('#item-text').attr('class','cols-2');
              var item_media_type = TL.MediaType(item_media_dict);
              var item_media = new item_media_type.cls(item_media_dict);
              item_media.addTo(document.getElementById('item-media'));
              item_media.loadMedia();
            }
          }
        })
      });
    });
  </script>
</body>
</html>
